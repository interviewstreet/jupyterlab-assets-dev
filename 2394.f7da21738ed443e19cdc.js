"use strict";(self["webpackChunk_jupyterlab_application_top"]=self["webpackChunk_jupyterlab_application_top"]||[]).push([[2394],{32394:(e,t,n)=>{n.r(t);n.d(t,{CodeExtractorsManager:()=>q,DefaultMap:()=>y,DocumentConnectionManager:()=>P,EditorAdapter:()=>c,FeatureManager:()=>V,ILSPCodeExtractorsManager:()=>C,ILSPDocumentConnectionManager:()=>_,ILSPFeatureManager:()=>v,ILanguageServerManager:()=>m,IWidgetLSPAdapterTracker:()=>D,LanguageServerManager:()=>$,Method:()=>S,ProtocolCoordinates:()=>j,TextForeignCodeExtractor:()=>G,UpdateManager:()=>Z,VirtualDocument:()=>J,VirtualDocumentInfo:()=>K,WidgetLSPAdapter:()=>d,WidgetLSPAdapterTracker:()=>g,collectDocuments:()=>X,expandDottedPaths:()=>L,expandPath:()=>M,isEqual:()=>H,isWithinRange:()=>Y,offsetAtPosition:()=>B,positionAtOffset:()=>z,sleep:()=>w,untilReady:()=>E});var i=n(63637);var s=n.n(i);var o=n(87447);var r=n(50724);var a=n(19289);class c{constructor(e){this._widgetAdapter=e.widgetAdapter;this._extensions=e.extensions;void e.editor.ready().then((t=>{this._injectExtensions(e.editor)}))}dispose(){if(this.isDisposed){return}this.isDisposed=true;a.Signal.clearData(this)}_injectExtensions(e){const t=e.getEditor();if(t.isDisposed){return}this._extensions.forEach((n=>{const i=n.factory({path:this._widgetAdapter.widget.context.path,editor:e,widgetAdapter:this._widgetAdapter,model:t.model,inline:true});if(!i){return}t.injectExtension(i.instance(t))}))}}const l=o.Dialog.createButton;const u={"text/x-rsrc":"r","text/x-r-source":"r","text/x-ipython":"python"};class d{constructor(e,t){this.widget=e;this.options=t;this._adapterConnected=new a.Signal(this);this._activeEditorChanged=new a.Signal(this);this._editorAdded=new a.Signal(this);this._editorRemoved=new a.Signal(this);this._disposed=new a.Signal(this);this._isDisposed=false;this._virtualDocument=null;this._connectionManager=t.connectionManager;this._isConnected=false;this._trans=(t.translator||r.nullTranslator).load("jupyterlab");this.widget.context.saveState.connect(this.onSaveState,this);this.connectionManager.closed.connect(this.onConnectionClosed,this);this.widget.disposed.connect(this.dispose,this);this._editorToAdapter=new WeakMap;this.editorAdded.connect(this._onEditorAdded,this);this.editorRemoved.connect(this._onEditorRemoved,this);this._connectionManager.languageServerManager.sessionsChanged.connect(this._onLspSessionOrFeatureChanged,this);this.options.featureManager.featureRegistered.connect(this._onLspSessionOrFeatureChanged,this)}get isDisposed(){return this._isDisposed}get hasMultipleEditors(){return this.editors.length>1}get widgetId(){return this.widget.id}get language(){if(u.hasOwnProperty(this.mimeType)){return u[this.mimeType]}else{let e=this.mimeType.split(";")[0];let[t,n]=e.split("/");if(t==="application"||t==="text"){if(n.startsWith("x-")){return n.substring(2)}else{return n}}else{return this.mimeType}}}get adapterConnected(){return this._adapterConnected}get activeEditorChanged(){return this._activeEditorChanged}get disposed(){return this._disposed}get editorAdded(){return this._editorAdded}get editorRemoved(){return this._editorRemoved}get isConnected(){return this._isConnected}get connectionManager(){return this._connectionManager}get trans(){return this._trans}get updateFinished(){return this._updateFinished}get virtualDocument(){return this._virtualDocument}onConnectionClosed(e,{virtualDocument:t}){if(t===this.virtualDocument){this.dispose()}}dispose(){if(this._isDisposed){return}this.editorAdded.disconnect(this._onEditorAdded,this);this.editorRemoved.disconnect(this._onEditorRemoved,this);this._connectionManager.languageServerManager.sessionsChanged.disconnect(this._onLspSessionOrFeatureChanged,this);this.options.featureManager.featureRegistered.disconnect(this._onLspSessionOrFeatureChanged,this);this._isDisposed=true;this.disconnect();this._virtualDocument=null;this._disposed.emit();a.Signal.clearData(this)}disconnect(){var e,t;const n=(e=this.virtualDocument)===null||e===void 0?void 0:e.uri;const{model:i}=this.widget.context;if(n){this.connectionManager.unregisterDocument(n)}i.contentChanged.disconnect(this._onContentChanged,this);for(let{ceEditor:s}of this.editors){this._editorRemoved.emit({editor:s})}(t=this.virtualDocument)===null||t===void 0?void 0:t.dispose()}updateDocuments(){if(this._isDisposed){console.warn("Cannot update documents: adapter disposed");return Promise.reject("Cannot update documents: adapter disposed")}return this.virtualDocument.updateManager.updateDocuments(this.editors)}documentChanged(e,t,n=false){if(this._isDisposed){console.warn("Cannot swap document: adapter disposed");return}let i=this.connectionManager.connections.get(e.uri);if(!(i===null||i===void 0?void 0:i.isReady)){console.log("Skipping document update signal: connection not ready");return}i.sendFullTextChange(e.value,e.documentInfo)}reloadConnection(){if(this.virtualDocument===null){return}this.disconnect();this.initVirtual();this.connectDocument(this.virtualDocument,true).catch(console.warn)}onSaveState(e,t){if(this.virtualDocument===null){return}if(t==="completed"){const e=[this.virtualDocument];for(let t of e){let n=this.connectionManager.connections.get(t.uri);if(!n){continue}n.sendSaved(t.documentInfo);for(let i of t.foreignDocuments.values()){e.push(i)}}}}async onConnected(e){let{virtualDocument:t}=e;this._adapterConnected.emit(e);this._isConnected=true;try{await this.updateDocuments()}catch(n){console.warn("Could not update documents",n);return}this.documentChanged(t,t,true);e.connection.serverNotifications["$/logTrace"].connect(((n,i)=>{console.log(e.connection.serverIdentifier,"trace",t.uri,i)}));e.connection.serverNotifications["window/logMessage"].connect(((e,t)=>{console.log(e.serverIdentifier+": "+t.message)}));e.connection.serverNotifications["window/showMessage"].connect(((e,t)=>{void(0,o.showDialog)({title:this.trans.__("Message from ")+e.serverIdentifier,body:t.message})}));e.connection.serverRequests["window/showMessageRequest"].setHandler((async t=>{const n=t.actions;const i=n?n.map((e=>l({label:e.title}))):[l({label:this.trans.__("Dismiss")})];const s=await(0,o.showDialog)({title:this.trans.__("Message from ")+e.connection.serverIdentifier,body:t.message,buttons:i});const r=i.indexOf(s.button);if(r===-1){return null}if(n){return n[r]}return null}))}async connectDocument(e,t=false){e.foreignDocumentOpened.connect(this.onForeignDocumentOpened,this);const n=await this._connect(e).catch(console.error);if(n&&n.connection){e.changed.connect(this.documentChanged,this);if(t){n.connection.sendOpenWhenReady(e.documentInfo)}}}initVirtual(){var e;(e=this._virtualDocument)===null||e===void 0?void 0:e.dispose();this._virtualDocument=this.createVirtualDocument();this._onLspSessionOrFeatureChanged()}async onForeignDocumentOpened(e,t){const{foreignDocument:n}=t;await this.connectDocument(n,true);n.foreignDocumentClosed.connect(this._onForeignDocumentClosed,this)}_onEditorAdded(e,t){const{editor:n}=t;const i=new c({editor:n,widgetAdapter:this,extensions:this.options.featureManager.extensionFactories()});this._editorToAdapter.set(n,i)}_onEditorRemoved(e,t){const{editor:n}=t;const i=this._editorToAdapter.get(n);i===null||i===void 0?void 0:i.dispose();this._editorToAdapter.delete(n)}_onForeignDocumentClosed(e,t){const{foreignDocument:n}=t;n.foreignDocumentClosed.disconnect(this._onForeignDocumentClosed,this);n.foreignDocumentOpened.disconnect(this.onForeignDocumentOpened,this);n.changed.disconnect(this.documentChanged,this)}async _connect(e){let t=e.language;let n={textDocument:{synchronization:{dynamicRegistration:true,willSave:false,didSave:true,willSaveWaitUntil:false}},workspace:{didChangeConfiguration:{dynamicRegistration:true}}};n=s()(n,this.options.featureManager.clientCapabilities());let i={capabilities:n,virtualDocument:e,language:t,hasLspSupportedFile:e.hasLspSupportedFile};let o=await this.connectionManager.connect(i);if(o){await this.onConnected({virtualDocument:e,connection:o});return{connection:o,virtualDocument:e}}else{return undefined}}async _onContentChanged(e){const t=this.updateDocuments();if(!t){console.warn("Could not update documents");return}this._updateFinished=t.catch(console.warn);await this.updateFinished}_shouldUpdateVirtualDocument(){const{languageServerManager:e}=this.connectionManager;return e.isEnabled&&this.options.featureManager.features.length>0}_onLspSessionOrFeatureChanged(){if(!this._virtualDocument){return}const{model:e}=this.widget.context;if(this._shouldUpdateVirtualDocument()){e.contentChanged.connect(this._onContentChanged,this)}else{e.contentChanged.disconnect(this._onContentChanged,this)}}}var h=n(35627);class g{constructor(e){this._isDisposed=false;this._current=null;this._adapters=new Set;this._adapterAdded=new a.Signal(this);this._adapterUpdated=new a.Signal(this);this._currentChanged=new a.Signal(this);const t=this._shell=e.shell;t.currentChanged.connect(((e,t)=>{let n=t.newValue;if(!n||!(n instanceof h.DocumentWidget)){return}const i=this.find((e=>e.widget===n));if(!i){return}this._current=i;this._currentChanged.emit(i)}))}get currentChanged(){return this._currentChanged}get currentAdapter(){return this._current}get size(){return this._adapters.size}get adapterAdded(){return this._adapterAdded}get adapterUpdated(){return this._adapterUpdated}add(e){if(e.isDisposed){const t="A disposed object cannot be added.";console.warn(t,e);throw new Error(t)}if(this._adapters.has(e)){const t="This object already exists in the pool.";console.warn(t,e);throw new Error(t)}this._adapters.add(e);this._adapterAdded.emit(e);e.disposed.connect((()=>{this._adapters.delete(e);if(e===this._current){this._current=null;this._currentChanged.emit(this._current)}}),this);const t=this._shell.activeWidget;if(!t||!(t instanceof h.DocumentWidget)){this._current=e;this._currentChanged.emit(e)}}get isDisposed(){return this._isDisposed}dispose(){if(this.isDisposed){return}this._isDisposed=true;this._adapters.clear();a.Signal.clearData(this)}find(e){const t=this._adapters.values();for(const n of t){if(e(n)){return n}}return undefined}forEach(e){this._adapters.forEach(e)}filter(e){const t=[];this.forEach((n=>{if(e(n)){t.push(n)}}));return t}has(e){return this._adapters.has(e)}}var p=n(78098);var f=n(55172);var m;(function(e){e.URL_NS="lsp"})(m||(m={}));const _=new f.Token("@jupyterlab/lsp:ILSPDocumentConnectionManager","Provides the virtual documents and language server connections service.");const v=new f.Token("@jupyterlab/lsp:ILSPFeatureManager","Provides the language server feature manager. This token is required to register new client capabilities.");const C=new f.Token("@jupyterlab/lsp:ILSPCodeExtractorsManager","Provides the code extractor manager. This token is required in your extension to register code extractor allowing the creation of multiple virtual document from an opened document.");const D=new f.Token("@jupyterlab/lsp:IWidgetLSPAdapterTracker","Provides the WidgetLSPAdapter tracker. This token is required in your extension to track WidgetLSPAdapters.");var S;(function(e){let t;(function(e){e["PUBLISH_DIAGNOSTICS"]="textDocument/publishDiagnostics";e["SHOW_MESSAGE"]="window/showMessage";e["LOG_TRACE"]="$/logTrace";e["LOG_MESSAGE"]="window/logMessage"})(t=e.ServerNotification||(e.ServerNotification={}));let n;(function(e){e["DID_CHANGE"]="textDocument/didChange";e["DID_CHANGE_CONFIGURATION"]="workspace/didChangeConfiguration";e["DID_OPEN"]="textDocument/didOpen";e["DID_SAVE"]="textDocument/didSave";e["INITIALIZED"]="initialized";e["SET_TRACE"]="$/setTrace"})(n=e.ClientNotification||(e.ClientNotification={}));let i;(function(e){e["REGISTER_CAPABILITY"]="client/registerCapability";e["SHOW_MESSAGE_REQUEST"]="window/showMessageRequest";e["UNREGISTER_CAPABILITY"]="client/unregisterCapability";e["WORKSPACE_CONFIGURATION"]="workspace/configuration"})(i=e.ServerRequest||(e.ServerRequest={}));let s;(function(e){e["CODE_ACTION"]="textDocument/codeAction";e["COMPLETION"]="textDocument/completion";e["COMPLETION_ITEM_RESOLVE"]="completionItem/resolve";e["DEFINITION"]="textDocument/definition";e["DOCUMENT_COLOR"]="textDocument/documentColor";e["DOCUMENT_HIGHLIGHT"]="textDocument/documentHighlight";e["DOCUMENT_SYMBOL"]="textDocument/documentSymbol";e["HOVER"]="textDocument/hover";e["IMPLEMENTATION"]="textDocument/implementation";e["INITIALIZE"]="initialize";e["REFERENCES"]="textDocument/references";e["RENAME"]="textDocument/rename";e["SIGNATURE_HELP"]="textDocument/signatureHelp";e["TYPE_DEFINITION"]="textDocument/typeDefinition";e["LINKED_EDITING_RANGE"]="textDocument/linkedEditingRange";e["INLINE_VALUE"]="textDocument/inlineValue";e["INLAY_HINT"]="textDocument/inlayHint";e["WORKSPACE_SYMBOL"]="workspace/symbol";e["WORKSPACE_SYMBOL_RESOLVE"]="workspaceSymbol/resolve";e["FORMATTING"]="textDocument/formatting";e["RANGE_FORMATTING"]="textDocument/rangeFormatting"})(s=e.ClientRequest||(e.ClientRequest={}))})(S||(S={}));async function w(e){return new Promise((t=>{setTimeout((()=>{t()}),e)}))}function E(e,t=35,n=50,i=(e=>e)){return(async()=>{let s=0;while(e()!==true){s+=1;if(t!==-1&&s>t){throw Error("Too many retrials")}n=i(n);await w(n)}return e})()}function L(e){const t=[];for(let n in e){const i=M(n.split("."),e[n]);t.push(i)}return s()({},...t)}const M=(e,t)=>{const n=Object.create(null);let i=n;e.forEach(((n,s)=>{i[n]=Object.create(null);if(s===e.length-1){i[n]=t}else{i=i[n]}}));return n};class y extends Map{constructor(e,t){super(t);this.defaultFactory=e}get(e){return this.getOrCreate(e)}getOrCreate(e,...t){if(this.has(e)){return super.get(e)}else{let n=this.defaultFactory(e,...t);this.set(e,n);return n}}}function I(e,t){const n=JSON.parse(JSON.stringify(e));const{method:i,registerOptions:s}=t;const o=i.substring(13)+"Provider";if(o){if(!s){n[o]=true}else{n[o]=JSON.parse(JSON.stringify(s))}}else{console.warn("Could not register server capability.",t);return null}return n}function O(e,t){const n=JSON.parse(JSON.stringify(e));const{method:i}=t;const s=i.substring(13)+"Provider";delete n[s];return n}var x=n(25080);class T{constructor(e){this.openedUris=new Map;this._isConnected=false;this._isInitialized=false;this._disposables=[];this._disposed=new a.Signal(this);this._isDisposed=false;this._rootUri=e.rootUri}get isConnected(){return this._isConnected}get isInitialized(){return this._isInitialized}get isReady(){return this._isConnected&&this._isInitialized}get disposed(){return this._disposed}get isDisposed(){return this._isDisposed}connect(e){this.socket=e;(0,x.listen)({webSocket:this.socket,logger:new x.ConsoleLogger,onConnection:e=>{e.listen();this._isConnected=true;this.connection=e;this.sendInitialize();const t=this.connection.onRequest("client/registerCapability",(e=>{e.registrations.forEach((e=>{try{this.serverCapabilities=I(this.serverCapabilities,e)}catch(t){console.error(t)}}))}));this._disposables.push(t);const n=this.connection.onRequest("client/unregisterCapability",(e=>{e.unregisterations.forEach((e=>{this.serverCapabilities=O(this.serverCapabilities,e)}))}));this._disposables.push(n);const i=this.connection.onClose((()=>{this._isConnected=false}));this._disposables.push(i)}})}close(){if(this.connection){this.connection.dispose()}this.openedUris.clear();this.socket.close()}sendInitialize(){if(!this._isConnected){return}this.openedUris.clear();const e=this.initializeParams();this.connection.sendRequest("initialize",e).then((e=>{this.onServerInitialized(e)}),(e=>{console.warn("LSP websocket connection initialization failure",e)}))}sendOpen(e){const t={textDocument:{uri:e.uri,languageId:e.languageId,text:e.text,version:e.version}};this.connection.sendNotification("textDocument/didOpen",t).catch(console.error);this.openedUris.set(e.uri,true);this.sendChange(e)}sendChange(e){if(!this.isReady){return}if(!this.openedUris.get(e.uri)){this.sendOpen(e);return}const t={textDocument:{uri:e.uri,version:e.version},contentChanges:[{text:e.text}]};this.connection.sendNotification("textDocument/didChange",t).catch(console.error);e.version++}sendSaved(e){if(!this.isReady){return}const t={textDocument:{uri:e.uri,version:e.version},text:e.text};this.connection.sendNotification("textDocument/didSave",t).catch(console.error)}sendConfigurationChange(e){if(!this.isReady){return}this.connection.sendNotification("workspace/didChangeConfiguration",e).catch(console.error)}dispose(){if(this._isDisposed){return}this._isDisposed=true;this._disposables.forEach((e=>{e.dispose()}));this._disposed.emit();a.Signal.clearData(this)}onServerInitialized(e){this._isInitialized=true;this.serverCapabilities=e.capabilities;this.connection.sendNotification("initialized",{}).catch(console.error);this.connection.sendNotification("workspace/didChangeConfiguration",{settings:{}}).catch(console.error)}initializeParams(){return{capabilities:{},processId:null,rootUri:this._rootUri,workspaceFolders:null}}}class b{constructor(e,t,n){this.connection=e;this.method=t;this.emitter=n}request(e){this.emitter.log(F.clientRequested,{method:this.method,message:e});return this.connection.sendRequest(this.method,e).then((t=>{this.emitter.log(F.resultForClient,{method:this.method,message:e});return t}))}}class R{constructor(e,t,n){this.connection=e;this.method=t;this.emitter=n;this.connection.onRequest(t,this._handle.bind(this));this._handler=null}setHandler(e){this._handler=e}clearHandler(){this._handler=null}_handle(e){this.emitter.log(F.serverRequested,{method:this.method,message:e});if(!this._handler){return new Promise((()=>undefined))}return this._handler(e,this.emitter).then((e=>{this.emitter.log(F.responseForServer,{method:this.method,message:e});return e}))}}const N={TEXT_DOCUMENT_SYNC:"textDocumentSync",COMPLETION:"completionProvider",HOVER:"hoverProvider",SIGNATURE_HELP:"signatureHelpProvider",DECLARATION:"declarationProvider",DEFINITION:"definitionProvider",TYPE_DEFINITION:"typeDefinitionProvider",IMPLEMENTATION:"implementationProvider",REFERENCES:"referencesProvider",DOCUMENT_HIGHLIGHT:"documentHighlightProvider",DOCUMENT_SYMBOL:"documentSymbolProvider",CODE_ACTION:"codeActionProvider",CODE_LENS:"codeLensProvider",DOCUMENT_LINK:"documentLinkProvider",COLOR:"colorProvider",DOCUMENT_FORMATTING:"documentFormattingProvider",DOCUMENT_RANGE_FORMATTING:"documentRangeFormattingProvider",DOCUMENT_ON_TYPE_FORMATTING:"documentOnTypeFormattingProvider",RENAME:"renameProvider",FOLDING_RANGE:"foldingRangeProvider",EXECUTE_COMMAND:"executeCommandProvider",SELECTION_RANGE:"selectionRangeProvider",WORKSPACE_SYMBOL:"workspaceSymbolProvider",WORKSPACE:"workspace"};function A(e,t){const n={};for(let i of Object.values(e)){n[i]=t(i)}return n}var F;(function(e){e[e["clientNotifiedServer"]=0]="clientNotifiedServer";e[e["serverNotifiedClient"]=1]="serverNotifiedClient";e[e["serverRequested"]=2]="serverRequested";e[e["clientRequested"]=3]="clientRequested";e[e["resultForClient"]=4]="resultForClient";e[e["responseForServer"]=5]="responseForServer"})(F||(F={}));class k extends T{constructor(e){super(e);this._closingManually=false;this._closeSignal=new a.Signal(this);this._errorSignal=new a.Signal(this);this._serverInitialized=new a.Signal(this);this._options=e;this.logAllCommunication=false;this.serverIdentifier=e.serverIdentifier;this.serverLanguage=e.languageId;this.documentsToOpen=[];this.clientNotifications=this.constructNotificationHandlers(S.ClientNotification);this.serverNotifications=this.constructNotificationHandlers(S.ServerNotification)}get closeSignal(){return this._closeSignal}get errorSignal(){return this._errorSignal}get serverInitialized(){return this._serverInitialized}dispose(){if(this.isDisposed){return}Object.values(this.serverRequests).forEach((e=>e.clearHandler()));this.close();super.dispose()}log(e,t){if(this.logAllCommunication){console.log(e,t)}}sendOpenWhenReady(e){if(this.isReady){this.sendOpen(e)}else{this.documentsToOpen.push(e)}}sendSelectiveChange(e,t){this._sendChange([e],t)}sendFullTextChange(e,t){this._sendChange([{text:e}],t)}provides(e){return!!(this.serverCapabilities&&this.serverCapabilities[e])}close(){try{this._closingManually=true;super.close()}catch(e){this._closingManually=false}}connect(e){super.connect(e);E((()=>this.isConnected),-1).then((()=>{const e=this.connection.onClose((()=>{this._isConnected=false;this._closeSignal.emit(this._closingManually)}));this._disposables.push(e)})).catch((()=>{console.error("Could not connect onClose signal")}))}async getCompletionResolve(e){if(!this.isReady){return}return this.connection.sendRequest("completionItem/resolve",e)}constructNotificationHandlers(e){const t=()=>new a.Signal(this);return A(e,t)}constructClientRequestHandler(e){return A(e,(e=>new b(this.connection,e,this)))}constructServerRequestHandler(e){return A(e,(e=>new R(this.connection,e,this)))}initializeParams(){return{...super.initializeParams(),capabilities:this._options.capabilities,initializationOptions:null,processId:null,workspaceFolders:null}}onServerInitialized(e){this.afterInitialized();super.onServerInitialized(e);while(this.documentsToOpen.length){this.sendOpen(this.documentsToOpen.pop())}this._serverInitialized.emit(this.serverCapabilities)}afterInitialized(){const e=this.connection.onError((e=>this._errorSignal.emit(e)));this._disposables.push(e);for(const t of Object.values(S.ServerNotification)){const e=this.serverNotifications[t];const n=this.connection.onNotification(t,(n=>{this.log(F.serverNotifiedClient,{method:t,message:n});e.emit(n)}));this._disposables.push(n)}for(const t of Object.values(S.ClientNotification)){const e=this.clientNotifications[t];e.connect(((e,n)=>{this.log(F.clientNotifiedServer,{method:t,message:n});this.connection.sendNotification(t,n).catch(console.error)}))}this.clientRequests=this.constructClientRequestHandler(S.ClientRequest);this.serverRequests=this.constructServerRequestHandler(S.ServerRequest);this.serverRequests["client/registerCapability"].setHandler((async e=>{e.registrations.forEach((e=>{try{const t=I(this.serverCapabilities,e);if(t===null){console.error(`Failed to register server capability: ${e}`);return}this.serverCapabilities=t}catch(t){console.error(t)}}))}));this.serverRequests["client/unregisterCapability"].setHandler((async e=>{e.unregisterations.forEach((e=>{this.serverCapabilities=O(this.serverCapabilities,e)}))}));this.serverRequests["workspace/configuration"].setHandler((async e=>e.items.map((e=>null))))}_sendChange(e,t){if(!this.isReady){return}if(t.uri.length===0){return}if(!this.openedUris.get(t.uri)){this.sendOpen(t)}const n={textDocument:{uri:t.uri,version:t.version},contentChanges:e};this.connection.sendNotification("textDocument/didChange",n).catch(console.error);t.version++}}class P{constructor(e){this.onNewConnection=e=>{const t=(t,n)=>{console.error(n);let i=n.length&&n.length>=1?n[0]:new Error;if(i.message.indexOf("code = 1005")!==-1){console.error(`Connection failed for ${e}`);this._forEachDocumentOfConnection(e,(t=>{console.error("disconnecting "+t.uri);this._closed.emit({connection:e,virtualDocument:t});this._ignoredLanguages.add(t.language);console.error(`Cancelling further attempts to connect ${t.uri} and other documents for this language (no support from the server)`)}))}else if(i.message.indexOf("code = 1006")!==-1){console.error("Connection closed by the server")}else{console.error("Connection error:",n)}};e.errorSignal.connect(t);const n=()=>{this._forEachDocumentOfConnection(e,(t=>{this._initialized.emit({connection:e,virtualDocument:t})}));this.updateServerConfigurations(this.initialConfigurations)};e.serverInitialized.connect(n);const i=(t,n)=>{if(!n){console.error("Connection unexpectedly disconnected")}else{console.log("Connection closed");this._forEachDocumentOfConnection(e,(t=>{this._closed.emit({connection:e,virtualDocument:t})}))}};e.closeSignal.connect(i)};this._initialized=new a.Signal(this);this._connected=new a.Signal(this);this._disconnected=new a.Signal(this);this._closed=new a.Signal(this);this._documentsChanged=new a.Signal(this);this.connections=new Map;this.documents=new Map;this.adapters=new Map;this._ignoredLanguages=new Set;this.languageServerManager=e.languageServerManager;U.setLanguageServerManager(e.languageServerManager);e.adapterTracker.adapterAdded.connect(((e,t)=>{const n=t.widget.context.path;this.registerAdapter(n,t)}))}get initialized(){return this._initialized}get connected(){return this._connected}get disconnected(){return this._disconnected}get closed(){return this._closed}get documentsChanged(){return this._documentsChanged}get ready(){return U.getLanguageServerManager().ready}connectDocumentSignals(e){e.foreignDocumentOpened.connect(this.onForeignDocumentOpened,this);e.foreignDocumentClosed.connect(this.onForeignDocumentClosed,this);this.documents.set(e.uri,e);this._documentsChanged.emit(this.documents)}disconnectDocumentSignals(e,t=true){e.foreignDocumentOpened.disconnect(this.onForeignDocumentOpened,this);e.foreignDocumentClosed.disconnect(this.onForeignDocumentClosed,this);this.documents.delete(e.uri);for(const n of e.foreignDocuments.values()){this.disconnectDocumentSignals(n,false)}if(t){this._documentsChanged.emit(this.documents)}}onForeignDocumentOpened(e,t){}onForeignDocumentClosed(e,t){const{foreignDocument:n}=t;this.unregisterDocument(n.uri,false);this.disconnectDocumentSignals(n)}registerAdapter(e,t){this.adapters.set(e,t);t.widget.context.pathChanged.connect(((n,i)=>{this.adapters.delete(e);this.adapters.set(i,t)}));t.disposed.connect((()=>{if(t.virtualDocument){this.documents.delete(t.virtualDocument.uri)}this.adapters.delete(e)}))}updateConfiguration(e){this.languageServerManager.setConfiguration(e)}updateServerConfigurations(e){let t;for(t in e){if(!e.hasOwnProperty(t)){continue}const n=e[t];const i=L(n.configuration||{});const s={settings:i};U.updateServerConfiguration(t,s)}}async retryToConnect(e,t,n=-1){let{virtualDocument:i}=e;if(this._ignoredLanguages.has(i.language)){return}let s=t*1e3;let o=false;while(n!==0&&!o){await this.connect(e).then((()=>{o=true})).catch((e=>{console.warn(e)}));console.log("will attempt to re-connect in "+s/1e3+" seconds");await w(s);s=s<5*1e3?s+500:s}}disconnect(e){U.disconnect(e)}async connect(e,t=30,n=5){let i=await this._connectSocket(e);let{virtualDocument:s}=e;if(!i){return}if(!i.isReady){try{await E((()=>i.isReady),Math.round(t*1e3/150),150)}catch(o){console.log(`Connection to ${s.uri} timed out after ${t} seconds, will continue retrying for another ${n} minutes`);try{await E((()=>i.isReady),60*n,1e3)}catch(r){console.log(`Connection to ${s.uri} timed out again after ${n} minutes, giving up`);return}}}this._connected.emit({connection:i,virtualDocument:s});return i}unregisterDocument(e,t=true){const n=this.connections.get(e);if(n){this.connections.delete(e);const i=new Set(this.connections.values());if(!i.has(n)){this.disconnect(n.serverIdentifier);n.dispose()}if(t){this._documentsChanged.emit(this.documents)}}}updateLogging(e,t){for(const n of this.connections.values()){n.logAllCommunication=e;if(t!==null){n.clientNotifications["$/setTrace"].emit({value:t})}}}async _connectSocket(e){let{language:t,capabilities:n,virtualDocument:i}=e;this.connectDocumentSignals(i);const s=P.solveUris(i,t);const o=this.languageServerManager.getMatchingServers({language:t});const r=o.length===0?null:o[0];if(!s){return}const a=await U.connection(t,r,s,this.onNewConnection,n);this.connections.set(i.uri,a);return a}_forEachDocumentOfConnection(e,t){for(const[n,i]of this.connections.entries()){if(e!==i){continue}t(this.documents.get(n))}}}(function(e){function t(e,t){var n;const i=U.getLanguageServerManager();const s=i.settings.wsUrl;const o=p.PageConfig.getOption("rootUri");const r=p.PageConfig.getOption("virtualDocumentsUri");const a={language:t};const c=i.getMatchingServers(a);const l=c.length===0?null:c[0];if(l===null){return}const u=i.getMatchingSpecs(a);const d=u.get(l);if(!d){console.warn(`Specification not available for server ${l}`)}const h=(n=d===null||d===void 0?void 0:d.requires_documents_on_disk)!==null&&n!==void 0?n:true;const g=!h;const f=e.hasLspSupportedFile||g?o:r;let m=p.URLExt.join(f,e.uri);if(!m.startsWith("file:///")&&m.startsWith("file://")){m=m.replace("file://","file:///");if(m.startsWith("file:///users/")&&f.startsWith("file:///Users/")){m=m.replace("file:///users/","file:///Users/")}}return{base:f,document:m,server:p.URLExt.join("ws://jupyter-lsp",t),socket:p.URLExt.join(s,"lsp","ws",l)}}e.solveUris=t})(P||(P={}));var U;(function(e){const t=new Map;let n;function i(){return n}e.getLanguageServerManager=i;function s(e){n=e}e.setLanguageServerManager=s;function o(e){const n=t.get(e);if(n){n.close();t.delete(e)}}e.disconnect=o;async function r(n,i,s,o,r){let a=t.get(i);if(!a){const{settings:a}=e.getLanguageServerManager();const c=new a.WebSocket(s.socket);const l=new k({languageId:n,serverUri:s.server,rootUri:s.base,serverIdentifier:i,capabilities:r});t.set(i,l);l.connect(c);o(l)}a=t.get(i);return a}e.connection=r;function a(e,n){const i=t.get(e);if(i){i.sendConfigurationChange(n)}}e.updateServerConfiguration=a})(U||(U={}));class q{constructor(){this._extractorMap=new Map;this._extractorMapAnyLanguage=new Map}getExtractors(e,t){var n,i;if(t){const i=this._extractorMap.get(e);if(!i){return[]}return(n=i.get(t))!==null&&n!==void 0?n:[]}else{return(i=this._extractorMapAnyLanguage.get(e))!==null&&i!==void 0?i:[]}}register(e,t){const n=e.cellType;if(t){n.forEach((n=>{if(!this._extractorMap.has(n)){this._extractorMap.set(n,new Map)}const i=this._extractorMap.get(n);const s=i.get(t);if(!s){i.set(t,[e])}else{s.push(e)}}))}else{n.forEach((t=>{if(!this._extractorMapAnyLanguage.has(t)){this._extractorMapAnyLanguage.set(t,[])}this._extractorMapAnyLanguage.get(t).push(e)}))}}}function H(e,t){return t&&e.line===t.line&&e.ch===t.ch}function z(e,t){let n=0;let i=0;for(let s of t){if(s.length+1<=e){e-=s.length+1;n+=1}else{i=e;break}}return{line:n,column:i}}function B(e,t,n=false){let i=n?0:1;let s=0;for(let o=0;o<t.length;o++){let n=t[o];if(e.line>o){s+=n.length+i}else{s+=e.column;break}}return s}var j;(function(e){function t(e,t){const{line:n,character:i}=e;return n>=t.start.line&&n<=t.end.line&&(n!=t.start.line||i>t.start.character)&&(n!=t.end.line||i<=t.end.character)}e.isWithinRange=t})(j||(j={}));class G{constructor(e){this.language=e.language;this.standalone=e.isStandalone;this.fileExtension=e.file_extension;this.cellType=e.cellType}hasForeignCode(e,t){return this.cellType.includes(t)}extractForeignCode(e){let t=e.split("\n");let n=new Array;let i=e;let s=z(0,t);let o=z(i.length,t);n.push({hostCode:"",foreignCode:i,range:{start:s,end:o},virtualShift:null});return n}}class V{constructor(){this.features=[];this._featureRegistered=new a.Signal(this)}get featureRegistered(){return this._featureRegistered}register(e){if(this.features.some((t=>t.id===e.id))){console.warn(`Feature with id ${e.id} is already registered, skipping.`)}else{this.features.push(e);this._featureRegistered.emit(e)}}clientCapabilities(){let e={};for(const t of this.features){if(!t.capabilities){continue}e=s()(e,t.capabilities)}return e}extensionFactories(){const e=[];for(const t of this.features){if(!t.extensionFactory){continue}e.push(t.extensionFactory)}return e}}var W=n(4702);class ${constructor(e){this._sessions=new Map;this._specs=new Map;this._warningsEmitted=new Set;this._ready=new f.PromiseDelegate;this._sessionsChanged=new a.Signal(this);this._isDisposed=false;this._enabled=true;this._settings=e.settings||W.ServerConnection.makeSettings();this._baseUrl=e.baseUrl||p.PageConfig.getBaseUrl();this._retries=e.retries||2;this._retriesInterval=e.retriesInterval||1e4;this._statusCode=-1;this._configuration={};this.fetchSessions().catch((e=>console.log(e)))}get isEnabled(){return this._enabled}get isDisposed(){return this._isDisposed}get settings(){return this._settings}get specs(){return this._specs}get statusUrl(){return p.URLExt.join(this._baseUrl,m.URL_NS,"status")}get sessionsChanged(){return this._sessionsChanged}get sessions(){return this._sessions}get ready(){return this._ready.promise}get statusCode(){return this._statusCode}async enable(){this._enabled=true;await this.fetchSessions()}disable(){this._enabled=false;this._sessions=new Map;this._sessionsChanged.emit(void 0)}dispose(){if(this._isDisposed){return}this._isDisposed=true;a.Signal.clearData(this)}setConfiguration(e){this._configuration=e}getMatchingServers(e){if(!e.language){console.error("Cannot match server by language: language not available; ensure that kernel and specs provide language and MIME type");return[]}const t=[];for(const[n,i]of this._sessions.entries()){if(this.isMatchingSpec(e,i.spec)){t.push(n)}}return t.sort(this.compareRanks.bind(this))}getMatchingSpecs(e){const t=new Map;for(const[n,i]of this._specs.entries()){if(this.isMatchingSpec(e,i)){t.set(n,i)}}return t}async fetchSessions(){if(!this._enabled){return}let e=await W.ServerConnection.makeRequest(this.statusUrl,{method:"GET"},this._settings);this._statusCode=e.status;if(!e.ok){if(this._retries>0){this._retries-=1;setTimeout(this.fetchSessions.bind(this),this._retriesInterval)}else{this._ready.resolve(undefined);console.log("Missing jupyter_lsp server extension, skipping.")}return}let t;try{const n=await e.json();t=n.sessions;try{this.version=n.version;this._specs=new Map(Object.entries(n.specs))}catch(i){console.warn(i)}}catch(i){console.warn(i);this._ready.resolve(undefined);return}for(let s of Object.keys(t)){let e=s;if(this._sessions.has(e)){Object.assign(this._sessions.get(e)||{},t[s])}else{this._sessions.set(e,t[s])}}const n=this._sessions.keys();for(const s in n){if(!t[s]){let e=s;this._sessions.delete(e)}}this._sessionsChanged.emit(void 0);this._ready.resolve(undefined)}isMatchingSpec(e,t){const n=e.language.toLocaleLowerCase();return t.languages.some((e=>e.toLocaleLowerCase()==n))}warnOnce(e){if(!this._warningsEmitted.has(e)){this._warningsEmitted.add(e);console.warn(e)}}compareRanks(e,t){var n,i,s,o;const r=50;const a=(i=(n=this._configuration[e])===null||n===void 0?void 0:n.rank)!==null&&i!==void 0?i:r;const c=(o=(s=this._configuration[t])===null||s===void 0?void 0:s.rank)!==null&&o!==void 0?o:r;if(a==c){this.warnOnce(`Two matching servers: ${e} and ${t} have the same rank; choose which one to use by changing the rank in Advanced Settings Editor`);return e.localeCompare(t)}return c-a}}function Y(e,t){if(t.start.line===t.end.line){return e.line===t.start.line&&e.column>=t.start.column&&e.column<=t.end.column}return e.line===t.start.line&&e.column>=t.start.column&&e.line<t.end.line||e.line>t.start.line&&e.column<=t.end.column&&e.line===t.end.line||e.line>t.start.line&&e.line<t.end.line}class K{constructor(e){this.version=0;this._document=e}get text(){return this._document.value}get uri(){const e=P.solveUris(this._document,this.languageId);if(!e){return""}return e.document}get languageId(){return this._document.language}}class J{constructor(e){this.blankLinesBetweenCells=2;this._isDisposed=false;this._foreignDocumentClosed=new a.Signal(this);this._foreignDocumentOpened=new a.Signal(this);this._changed=new a.Signal(this);this.options=e;this.path=this.options.path;this.fileExtension=e.fileExtension;this.hasLspSupportedFile=e.hasLspSupportedFile;this.parent=e.parent;this.language=e.language;this.virtualLines=new Map;this.sourceLines=new Map;this.foreignDocuments=new Map;this._editorToSourceLine=new Map;this._foreignCodeExtractors=e.foreignCodeExtractors;this.standalone=e.standalone||false;this.instanceId=J.instancesCount;J.instancesCount+=1;this.unusedStandaloneDocuments=new y((()=>new Array));this._remainingLifetime=6;this.documentInfo=new K(this);this.updateManager=new Z(this);this.updateManager.updateBegan.connect(this._updateBeganSlot,this);this.updateManager.blockAdded.connect(this._blockAddedSlot,this);this.updateManager.updateFinished.connect(this._updateFinishedSlot,this);this.clear()}static ceToCm(e){return{line:e.line,ch:e.column}}get isDisposed(){return this._isDisposed}get foreignDocumentClosed(){return this._foreignDocumentClosed}get foreignDocumentOpened(){return this._foreignDocumentOpened}get changed(){return this._changed}get virtualId(){return this.standalone?this.instanceId+"("+this.language+")":this.language}get ancestry(){if(!this.parent){return[this]}return this.parent.ancestry.concat([this])}get idPath(){if(!this.parent){return this.virtualId}return this.parent.idPath+"-"+this.virtualId}get uri(){const e=encodeURI(this.path);if(!this.parent){return e}return e+"."+this.idPath+"."+this.fileExtension}get value(){let e="\n".repeat(this.blankLinesBetweenCells);return this.lineBlocks.join(e)}get lastLine(){const e=this.lineBlocks[this.lineBlocks.length-1].split("\n");return e[e.length-1]}get root(){return this.parent?this.parent.root:this}dispose(){if(this._isDisposed){return}this._isDisposed=true;this.parent=null;this.closeAllForeignDocuments();this.updateManager.dispose();this.foreignDocuments.clear();this.sourceLines.clear();this.unusedStandaloneDocuments.clear();this.virtualLines.clear();this.documentInfo=null;this.lineBlocks=null;a.Signal.clearData(this)}clear(){this.unusedStandaloneDocuments.clear();for(let e of this.foreignDocuments.values()){e.clear();if(e.standalone){let t=this.unusedStandaloneDocuments.get(e.language);t.push(e)}}this.virtualLines.clear();this.sourceLines.clear();this.lastVirtualLine=0;this.lastSourceLine=0;this.lineBlocks=[]}documentAtSourcePosition(e){let t=this.sourceLines.get(e.line);if(!t){return this}let n={line:t.editorLine,column:e.ch};for(let[i,{virtualDocument:s}]of t.foreignDocumentsMap){if(Y(n,i)){let e={line:n.line-i.start.line,ch:n.column-i.start.column};return s.documentAtSourcePosition(e)}}return this}isWithinForeign(e){let t=this.sourceLines.get(e.line);let n={line:t.editorLine,column:e.ch};for(let[i]of t.foreignDocumentsMap){if(Y(n,i)){return true}}return false}transformFromEditorToRoot(e,t){if(!this._editorToSourceLine.has(e)){console.log("Editor not found in _editorToSourceLine map");return null}let n=this._editorToSourceLine.get(e);return{...t,line:t.line+n}}virtualPositionAtDocument(e){let t=this.sourceLines.get(e.line);if(t==null){throw new Error("Source line not mapped to virtual position")}let n=t.virtualLine;let i={line:t.editorLine,column:e.ch};for(let[s,o]of t.foreignDocumentsMap){const{virtualLine:e,virtualDocument:t}=o;if(Y(i,s)){let n={line:i.line-s.start.line,ch:i.column-s.start.column};if(t.isWithinForeign(n)){return this.virtualPositionAtDocument(n)}else{n.line+=e;return n}}}return{ch:e.ch,line:n}}appendCodeBlock(e,t={line:0,column:0},n){let i=e.value;let s=e.ceEditor;if(this.isDisposed){console.warn("Cannot append code block: document disposed");return}let o=i.split("\n");let{lines:r,foreignDocumentsMap:a}=this.prepareCodeBlock(e,t);for(let c=0;c<r.length;c++){this.virtualLines.set(this.lastVirtualLine+c,{skipInspect:[],editor:s,sourceLine:this.lastSourceLine+c})}for(let c=0;c<o.length;c++){this.sourceLines.set(this.lastSourceLine+c,{editorLine:c,editorShift:{line:t.line-((n===null||n===void 0?void 0:n.line)||0),column:c===0?t.column-((n===null||n===void 0?void 0:n.column)||0):0},editor:s,foreignDocumentsMap:a,virtualLine:this.lastVirtualLine+c})}this.lastVirtualLine+=r.length;this.lineBlocks.push(r.join("\n")+"\n");for(let c=0;c<this.blankLinesBetweenCells;c++){this.virtualLines.set(this.lastVirtualLine+c,{skipInspect:[this.idPath],editor:s,sourceLine:null})}this.lastVirtualLine+=this.blankLinesBetweenCells;this.lastSourceLine+=o.length}prepareCodeBlock(e,t={line:0,column:0}){let{cellCodeKept:n,foreignDocumentsMap:i}=this.extractForeignCode(e,t);let s=n.split("\n");return{lines:s,foreignDocumentsMap:i}}extractForeignCode(e,t){let n=new Map;let i=e.value;const s=this._foreignCodeExtractors.getExtractors(e.type,null);const o=this._foreignCodeExtractors.getExtractors(e.type,this.language);for(let r of[...s,...o]){if(!r.hasForeignCode(i,e.type)){continue}let s=r.extractForeignCode(i);let o="";for(let i of s){if(i.foreignCode!==null){if(i.range===null){console.log("Failure in foreign code extraction: `range` is null but `foreign_code` is not!");continue}let s=this._chooseForeignDocument(r);n.set(i.range,{virtualLine:s.lastVirtualLine,virtualDocument:s,editor:e.ceEditor});let o={line:t.line+i.range.start.line,column:t.column+i.range.start.column};s.appendCodeBlock({value:i.foreignCode,ceEditor:e.ceEditor,type:"code"},o,i.virtualShift)}if(i.hostCode!=null){o+=i.hostCode}}i=o}return{cellCodeKept:i,foreignDocumentsMap:n}}closeForeign(e){this._foreignDocumentClosed.emit({foreignDocument:e,parentHost:this});this.foreignDocuments.delete(e.virtualId);e.closeAllForeignDocuments();e.foreignDocumentClosed.disconnect(this.forwardClosedSignal,this);e.foreignDocumentOpened.disconnect(this.forwardOpenedSignal,this);e.dispose()}closeAllForeignDocuments(){for(let e of this.foreignDocuments.values()){this.closeForeign(e)}}closeExpiredDocuments(){const e=new Set;for(const s of this.sourceLines.values()){for(const t of s.foreignDocumentsMap.values()){e.add(t.virtualDocument)}}const t=new Map;for(const[s,o]of this.foreignDocuments.entries()){const e=t.get(o);if(typeof e!=="undefined"){t.set(o,[...e,s])}t.set(o,[s])}const n=new Set(t.keys());const i=new Set([...n].filter((t=>!e.has(t))));for(let s of i.values()){s.remainingLifetime-=1;if(s.remainingLifetime<=0){s.dispose();const e=t.get(s);for(const t of e){this.foreignDocuments.delete(t)}}}}transformSourceToEditor(e){let t=this.sourceLines.get(e.line);let n=t.editorLine;let i=t.editorShift;return{ch:e.ch+(n===0?i.column:0),line:n+i.line}}transformVirtualToEditor(e){let t=this.transformVirtualToSource(e);if(t==null){return null}return this.transformSourceToEditor(t)}transformVirtualToSource(e){const t=this.virtualLines.get(e.line).sourceLine;if(t==null){return null}return{ch:e.ch,line:t}}transformVirtualToRoot(e){var t;const n=(t=this.virtualLines.get(e.line))===null||t===void 0?void 0:t.editor;const i=this.transformVirtualToEditor(e);if(!n||!i){return null}return this.root.transformFromEditorToRoot(n,i)}getEditorAtVirtualLine(e){let t=e.line;if(!this.virtualLines.has(t)){t-=1}return this.virtualLines.get(t).editor}getEditorAtSourceLine(e){return this.sourceLines.get(e.line).editor}maybeEmitChanged(){if(this.value!==this.previousValue){this._changed.emit(this)}this.previousValue=this.value;for(let e of this.foreignDocuments.values()){e.maybeEmitChanged()}}get remainingLifetime(){if(!this.parent){return Infinity}return this._remainingLifetime}set remainingLifetime(e){if(this.parent){this._remainingLifetime=e}}_chooseForeignDocument(e){let t;let n=this.foreignDocuments.has(e.language);if(!e.standalone&&n){t=this.foreignDocuments.get(e.language)}else{let n=this.unusedStandaloneDocuments.get(e.language);if(e.standalone&&n.length>0){t=n.pop()}else{t=this.openForeign(e.language,e.standalone,e.fileExtension)}}return t}openForeign(e,t,n){let i=new this.constructor({...this.options,parent:this,standalone:t,fileExtension:n,language:e});const s={foreignDocument:i,parentHost:this};this._foreignDocumentOpened.emit(s);i.foreignDocumentClosed.connect(this.forwardClosedSignal,this);i.foreignDocumentOpened.connect(this.forwardOpenedSignal,this);this.foreignDocuments.set(i.virtualId,i);return i}forwardClosedSignal(e,t){this._foreignDocumentClosed.emit(t)}forwardOpenedSignal(e,t){this._foreignDocumentOpened.emit(t)}_updateBeganSlot(){this._editorToSourceLineNew=new Map}_blockAddedSlot(e,t){this._editorToSourceLineNew.set(t.block.ceEditor,t.virtualDocument.lastSourceLine)}_updateFinishedSlot(){this._editorToSourceLine=this._editorToSourceLineNew}}J.instancesCount=0;function X(e){let t=new Set;t.add(e);for(let n of e.foreignDocuments.values()){let e=X(n);e.forEach(t.add,t)}return t}class Z{constructor(e){this.virtualDocument=e;this._isDisposed=false;this._updateDone=new Promise((e=>{e()}));this._isUpdateInProgress=false;this._updateLock=false;this._blockAdded=new a.Signal(this);this._documentUpdated=new a.Signal(this);this._updateBegan=new a.Signal(this);this._updateFinished=new a.Signal(this);this.documentUpdated.connect(this._onUpdated,this)}get updateDone(){return this._updateDone}get isDisposed(){return this._isDisposed}get blockAdded(){return this._blockAdded}get documentUpdated(){return this._documentUpdated}get updateBegan(){return this._updateBegan}get updateFinished(){return this._updateFinished}dispose(){if(this._isDisposed){return}this._isDisposed=true;this.documentUpdated.disconnect(this._onUpdated);a.Signal.clearData(this)}async withUpdateLock(e){await E((()=>this._canUpdate()),12,10).then((()=>{try{this._updateLock=true;e()}finally{this._updateLock=false}}))}async updateDocuments(e){let t=new Promise(((t,n)=>{E((()=>this._canUpdate()),10,5).then((()=>{if(this.isDisposed||!this.virtualDocument){t()}try{this._isUpdateInProgress=true;this._updateBegan.emit(e);this.virtualDocument.clear();for(let t of e){this._blockAdded.emit({block:t,virtualDocument:this.virtualDocument});this.virtualDocument.appendCodeBlock(t)}this._updateFinished.emit(e);if(this.virtualDocument){this._documentUpdated.emit(this.virtualDocument);this.virtualDocument.maybeEmitChanged()}t()}catch(i){console.warn("Documents update failed:",i);n(i)}finally{this._isUpdateInProgress=false}})).catch(console.error)}));this._updateDone=t;return t}_onUpdated(e,t){try{t.closeExpiredDocuments()}catch(n){console.warn("Failed to close expired documents")}}_canUpdate(){return!this.isDisposed&&!this._isUpdateInProgress&&!this._updateLock}}}}]);
//# sourceMappingURL=2394.f7da21738ed443e19cdc.js.map?v=f7da21738ed443e19cdc